events {}

http {
    # Only respond to VPN-accessible IPs 
    server {
        listen 80;
        server_name internal.thewordsleftbehind.com;

        location / {
            return 301 https://$host$request_uri;
        }
    }

    server {
            listen 443 ssl;
            server_name internal.thewordsleftbehind.com;

            access_log /var/log/nginx/admin.access.log combined;

            ssl_certificate /data/certificates/wildcard.thewordsleftbehind.com.crt;
            ssl_certificate_key /data/certificates/wildcard.thewordsleftbehind.com.key;

            # Frontend served at /
            location / {
                proxy_pass http://frontend-admin:80;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
            }

            # API served under /api/admin/
            location /api/admin/ {
                proxy_pass http://backend-admin:8000;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
            }
        }

    server {
        listen 80;
        server_name minio-internal.thewordsleftbehind.com;

        location / {
            return 301 https://$host$request_uri;
        }
    }

            server {
                    listen 443 ssl;
                    server_name minio-internal.thewordsleftbehind.com;

                    access_log /var/log/nginx/minio-internal.access.log combined;

                    ssl_certificate /data/certificates/wildcard.thewordsleftbehind.com.crt;
                    ssl_certificate_key /data/certificates/wildcard.thewordsleftbehind.com.key;

                    # Frontend served at /
                    location / {
                        proxy_pass http://minio:9001;
                        proxy_set_header Host $host;
                        proxy_set_header X-Real-IP $remote_addr;
                    }
        }

        server {
            listen 80;
            server_name grafana.thewordsleftbehind.com;

            location / {
                return 301 https://$host$request_uri;
            }
        }

    server {
            listen 443 ssl;
            server_name grafana.thewordsleftbehind.com;

            access_log /var/log/nginx/grafana.access.log combined;

            ssl_certificate /data/certificates/wildcard.thewordsleftbehind.com.crt;
            ssl_certificate_key /data/certificates/wildcard.thewordsleftbehind.com.key;

            # Frontend served at /
            location / {
                proxy_pass http://grafana:3000;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
            }
    }
}

events {}

http {
    # Only respond to VPN-accessible IPs (adjust this to your VPN subnet)
    server {
        listen 80;
        server_name internal.kdidp.art;

        location / {
            return 301 https://$host$request_uri;
        }
    }

    server {
            listen 443 ssl;
            server_name internal.kdidp.art;

            access_log /var/log/nginx/admin.access.log combined;

            ssl_certificate /etc/letsencrypt/live/kdidp.art-0001/fullchain.pem;
            ssl_certificate_key /etc/letsencrypt/live/kdidp.art-0001/privkey.pem;

            # Frontend served at /
            location / {
                proxy_pass http://frontend-admin:80;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
            }

            # API served under /api/admin/
            location /api/admin/ {
                proxy_pass http://backend-admin:8000;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
            }
        }

         server {
                listen 80;
                server_name minio-internal.kdidp.art;

                location / {
                    return 301 https://$host$request_uri;
                }
            }

            server {
                    listen 443 ssl;
                    server_name minio-internal.kdidp.art;

                    access_log /var/log/nginx/minio-internal.access.log combined;

                    ssl_certificate /etc/letsencrypt/live/kdidp.art-0001/fullchain.pem;
                    ssl_certificate_key /etc/letsencrypt/live/kdidp.art-0001/privkey.pem;

                    # Frontend served at /
                    location / {
                        proxy_pass http://minio:9001;
                        proxy_set_header Host $host;
                        proxy_set_header X-Real-IP $remote_addr;
                    }
        }

             server {
                    listen 80;
                    server_name grafana.kdidp.art;

                    location / {
                        return 301 https://$host$request_uri;
                    }
                }

                server {
                        listen 443 ssl;
                        server_name grafana.kdidp.art;

                        access_log /var/log/nginx/grafana.access.log combined;

                        ssl_certificate /etc/letsencrypt/live/kdidp.art-0001/fullchain.pem;
                        ssl_certificate_key /etc/letsencrypt/live/kdidp.art-0001/privkey.pem;

                        # Frontend served at /
                        location / {
                            proxy_pass http://grafana:3000;
                            proxy_set_header Host $host;
                            proxy_set_header X-Real-IP $remote_addr;
                        }
                    }
}
